name: Automatic Archive Sync and Stale Branch Cleanup

on:
  push:
    # ì–´ë–¤ ë¸Œëœì¹˜ë“  í‘¸ì‹œë  ë•Œ ì‹¤í–‰
    branches:
      - '**'

jobs:
  # 1. RpgArchieveë¡œ ì „ì²´ ì´ë ¥ì„ ë¯¸ëŸ¬ë§ ë™ê¸°í™”í•˜ëŠ” ì‘ì—…
  sync_to_archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RpgPlugin Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          token: ${{ secrets.ARCHIVE_TOKEN }}

      - name: Configure Git for Mirror Push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "action@github.com"
          
          # ğŸ’¡ ìˆ˜ì •ëœ ë¶€ë¶„: ë¦¬í¬ì§€í† ë¦¬ ì´ë¦„(RpgArchieve)ê³¼ ì†Œìœ ì ì´ë¦„(YuThhh)ì„ ì •í™•í•˜ê²Œ ìˆ˜ì •
          git remote add archive-remote https://x-access-token:${{ secrets.ARCHIVE_TOKEN }}@github.com/YuThhh/RpgArchieve.git
          
      - name: Execute Mirror Push to RpgArchieve
        run: |
          # ë¯¸ëŸ¬ë§ í‘¸ì‹œ (PATì— workflow ê¶Œí•œ í•„ìš”)
          git push archive-remote --mirror
          
  # 2. ì˜¤ë˜ëœ ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•˜ëŠ” ì‘ì—… (sync_to_archive ì‘ì—… ì„±ê³µ í›„ ì‹¤í–‰)
 # 2. ì˜¤ë˜ëœ ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•˜ëŠ” ì‘ì—… (clean_stale_branches ì‘ì—…)
  clean_stale_branches:
    runs-on: ubuntu-latest
    needs: [sync_to_archive]
    
    # ğŸ”‘ ì¶”ê°€í•  ë¶€ë¶„: ì´ ì‘ì—…ì´ ë¦¬í¬ì§€í† ë¦¬ ì½˜í…ì¸ ì— ì“°ê¸° ê¶Œí•œì„ ê°€ì§€ë„ë¡ ëª…ì‹œ
    permissions:
      contents: write # ì´ ì„¤ì •ì„ ì¶”ê°€í•´ì•¼ ë¸Œëœì¹˜ ì‚­ì œê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.
      
    steps:
      - name: Checkout RpgPlugin Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°

      - name: Calculate and Delete Stale Branches
        env:
          # ê¸°ì¤€ ë¸Œëœì¹˜ ì´ë¦„ (mainì´ë¼ë©´ mainìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”)
          BASE_BRANCH: master 
          COMMIT_THRESHOLD: 50 # 50 ì»¤ë°‹ ì´ìƒ ë’¤ì²˜ì§€ë©´ ì‚­ì œ
        run: |
          echo "Start checking branches against ${BASE_BRANCH}..."
          
          # ì›ê²© ì¶”ì  ë¸Œëœì¹˜ ëª©ë¡ì„ ê°€ì ¸ì™€ master/main ë¸Œëœì¹˜ì™€ HEAD ì¶”ì  ë¸Œëœì¹˜ë¥¼ ì œì™¸í•©ë‹ˆë‹¤.
          git branch -r | grep 'origin/' | grep -v '\->' | sed 's/origin\///' | grep -E -v "^(${BASE_BRANCH}|main)$" | while read branch_name; do
            
            # ğŸ’¡ git rev-list origin/ë¸Œëœì¹˜ì´ë¦„..origin/ê¸°ì¤€ë¸Œëœì¹˜ --count ë¡œ ì»¤ë°‹ ë’¤ì²˜ì§ ì •ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            COMMITS_BEHIND=$(git rev-list origin/${branch_name}..origin/${BASE_BRANCH} --count) 
            
            echo "ğŸ” Branch: ${branch_name} (Behind ${BASE_BRANCH}: ${COMMITS_BEHIND} commits)"
            
            # ë’¤ì²˜ì§„ ì»¤ë°‹ ìˆ˜ê°€ ì„ê³„ì¹˜(50) ì´ìƒì¼ ê²½ìš°
            if [ ${COMMITS_BEHIND} -ge ${COMMIT_THRESHOLD} ]; then
              echo "ğŸ—‘ï¸ Deleting stale branch: ${branch_name} (${COMMITS_BEHIND} commits behind ${BASE_BRANCH})"
              
              # ì›ê²© ë¦¬í¬ì§€í† ë¦¬ (origin = RpgPlugin)ì—ì„œ ë¸Œëœì¹˜ ì‚­ì œ
              git push origin --delete "${branch_name}"
              
              if [ $? -eq 0 ]; then
                echo "âœ… Branch ${branch_name} successfully deleted from origin (RpgPlugin)."
              else
                echo "âŒ Failed to delete branch ${branch_name}."
              fi
            fi
          done
