name: Automatic Archive Sync and Stale Branch Cleanup

on:
  push:
    # ğŸ”‘ ë³€ê²½ ì‚¬í•­ 1: main ë¸Œëœì¹˜ë¿ë§Œ ì•„ë‹ˆë¼, ëª¨ë“  ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    branches:
      - '**'

jobs:
  # 1. RpgArchiveë¡œ ì „ì²´ ì´ë ¥ì„ ë¯¸ëŸ¬ë§ ë™ê¸°í™”í•˜ëŠ” ì‘ì—…
  sync_to_archive:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout RpgPlugin Repository (Full History)
        uses: actions/checkout@v4
        with:
          # ëª¨ë“  ë¸Œëœì¹˜ì™€ íƒœê·¸ ì´ë ¥ì„ ê°€ì ¸ì˜¤ê¸° ìœ„í•´ fetch-depthë¥¼ 0ìœ¼ë¡œ ì„¤ì •
          fetch-depth: 0 
          # ê¸°ë³¸ GITHUB_TOKEN ëŒ€ì‹ , ì•„ì¹´ì´ë¸Œ ë¦¬í¬ì§€í† ë¦¬ì— í‘¸ì‹œí•  ê¶Œí•œì´ ìˆëŠ” ARCHIVE_TOKENì„ ì‚¬ìš©
          token: ${{ secrets.ARCHIVE_TOKEN }}

      - name: Configure Git for Mirror Push
        run: |
          # Git ì»¤ë°‹ ì£¼ì²´ ì„¤ì •
          git config user.name "GitHub Actions"
          git config user.email "action@github.com"
          
          # ì•„ì¹´ì´ë¸Œ ë¦¬í¬ì§€í† ë¦¬ì˜ URLì„ ì›ê²©ìœ¼ë¡œ ì¶”ê°€ (Secretì„ ì‚¬ìš©í•˜ì—¬ ì¸ì¦)
          # {YuThhh}ëŠ” ì •í™•í•˜ê²Œ ì…ë ¥ë˜ì–´ì•¼ í•©ë‹ˆë‹¤. (ì´ì „ì— ì¤‘ê´„í˜¸ ì œê±°ë¥¼ ìš”ì²­í–ˆì—ˆìŒ)
          git remote add archive-remote https://x-access-token:${{ secrets.ARCHIVE_TOKEN }}@github.com/YuThhh/RpgArchive.git
          
      - name: Execute Mirror Push to RpgArchive
        run: |
          # --mirror ì˜µì…˜ìœ¼ë¡œ ëª¨ë“  ë¸Œëœì¹˜, íƒœê·¸, ì»¤ë°‹ ì´ë ¥ì„ ê°•ì œ ë™ê¸°í™”(ë®ì–´ì“°ê¸°)í•©ë‹ˆë‹¤.
          git push archive-remote --mirror
          
  # 2. ì˜¤ë˜ëœ ë¸Œëœì¹˜ë¥¼ ì‚­ì œí•˜ëŠ” ì‘ì—… (ë³„ë„ ì‘ì—…)
  clean_stale_branches:
    runs-on: ubuntu-latest
    # ë™ê¸°í™” ì‘ì—…ê³¼ ë…ë¦½ì ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
    steps:
      - name: Checkout RpgPlugin Repository (Full History)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # ì „ì²´ ì´ë ¥ ê°€ì ¸ì˜¤ê¸°

      - name: Calculate and Delete Stale Branches
        env:
          # ğŸ’¡ ê¸°ì¤€ ë¸Œëœì¹˜: í˜„ì¬ 'master'ë¡œ ì„¤ì •ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ê¸°ë³¸ ë¸Œëœì¹˜ ì´ë¦„(main ë˜ëŠ” master)ì— ë§ì¶° ìˆ˜ì •í•˜ì„¸ìš”.
          BASE_BRANCH: master
          # ğŸ’¡ ì„ê³„ì¹˜: 50 ì»¤ë°‹ ë’¤ì²˜ì§€ë©´ ì‚­ì œ
          COMMIT_THRESHOLD: 50
        run: |
          echo "Start checking branches against ${BASE_BRANCH}..."
          
          # ì›ê²© ì¶”ì  ë¸Œëœì¹˜ ëª©ë¡ì„ ê°€ì ¸ì™€ master/main ë¸Œëœì¹˜ì™€ HEAD ì¶”ì  ë¸Œëœì¹˜ë¥¼ ì œì™¸í•©ë‹ˆë‹¤.
          # ëª¨ë“  ë¸Œëœì¹˜ì— ëŒ€í•´ masterì™€ì˜ ì»¤ë°‹ ë’¤ì²˜ì§ ì •ë„ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
          git branch -r | grep 'origin/' | grep -v '\->' | sed 's/origin\///' | grep -E -v "^(${BASE_BRANCH}|main)$" | while read branch_name; do
            # ë¸Œëœì¹˜ê°€ ê¸°ì¤€ ë¸Œëœì¹˜(${BASE_BRANCH})ë³´ë‹¤ ì–¼ë§ˆë‚˜ ë’¤ì²˜ì ¸ ìˆëŠ”ì§€ ì»¤ë°‹ ìˆ˜ë¥¼ ê³„ì‚°í•©ë‹ˆë‹¤.
            COMMITS_BEHIND=$(git rev-list ${branch_name}..${BASE_BRANCH} --count)
            
            echo "ğŸ” Branch: ${branch_name} (Behind ${BASE_BRANCH}: ${COMMITS_BEHIND} commits)"
            
            # ë’¤ì²˜ì§„ ì»¤ë°‹ ìˆ˜ê°€ ì„ê³„ì¹˜(50) ì´ìƒì¼ ê²½ìš°
            if [ ${COMMITS_BEHIND} -ge ${COMMIT_THRESHOLD} ]; then
              echo "ğŸ—‘ï¸ Deleting stale branch: ${branch_name} (${COMMITS_BEHIND} commits behind ${BASE_BRANCH})"
              
              # ì›ê²© ë¦¬í¬ì§€í† ë¦¬ (origin = RpgPlugin)ì—ì„œ ë¸Œëœì¹˜ ì‚­ì œ
              # GITHUB_TOKENì€ í˜„ì¬ ë¦¬í¬ì§€í† ë¦¬ì— ëŒ€í•œ ì“°ê¸° ê¶Œí•œì´ ìˆìœ¼ë¯€ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
              git push origin --delete "${branch_name}"
              
              if [ $? -eq 0 ]; then
                echo "âœ… Branch ${branch_name} successfully deleted from origin (RpgPlugin)."
              else
                echo "âŒ Failed to delete branch ${branch_name}."
              fi
            fi
          done
